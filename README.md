# Electricity-Theft-Detection-Tongling--master
# 电力用户窃电检测与定位装置开发与应用
## 项目主要介绍：
### 项目简介：
设计了一套基于STM32电能数据采集装置并实现了电能数据的采集、上报以及控制指令的接收，在小程序上对设备进行管理及窃电结果的显示。
### 主要职责：
1.硬件电路的设计与测试，利用嘉立创EDA绘制采集装置硬件原理图及PCB，并打板测试。

2.采集装置功能实现。负责移植FreeRTOS实时操作系统，在KEIL下采用C语言编程，负责采集芯片RN8302与STM32的SPI通信以及电能数据的采集；负责BC20通信模块的驱动，通过串口下发AT指令，实现BC20的激活、注册以及连网；采用MQTT协议将采集到的数据上报至云端服务器，并接收服务器下发的控制指令。

3.云端服务搭建与部署。在京东云服务器部署EMQX开源MQTT消息服务器和MySQL数据库。

4.窃电检测算法实现，在云服务器下，根据利用python实现互相关算法和LSTM神经网络，分别用于重建拓扑关系和判别母节点和子节点之间的电能是否守恒，并将窃电检测结果写入MySQL数据库。
### 项目成果：
电力数据测量误差小于1%，测试阶段累计为公司发现窃电用户约50户，累计挽回损失约10万元。

### 功能详细介绍
1.采集端：设计了一个以STM32F103C8T6为主控芯片的电能数据采集装置，自己绘制原理图和PCB并打板测试，通过RN8302芯片对各节点的电能数据进行采集，数据采集芯片利用SPI协议与STM32进行通信，然后STM32利用BC20模块通过MQTT协议进行数据的上报。

2.云服务器端：搭建了京东云服务器，并部署了EMQX开源MQTT消息服务器和MySQL数据库。采集端将数据上报EMQX，EMQX进行数据转发将采集端的数据入库、存储，方便后期数据的处理和历史数据的查看，利用云服务器的计算能力进行窃电算法的运行，设计了一个后台管理系统，用于移动端用户的授权与管理及设备安装管理。

3.移动端：设计了一个微信小程序，实现以下功能：采集设备的安装与管理、采集设备的远程控制、采集设备的数据查看以及窃电检测结果的查看。(1)采集设备的安装与管理：在对设备进行安装时，利用后台管理系统授权的二维码进行扫码安装，同时可以选择设备安装的位置，安装后的设备可以在微信小程序以及后台管理系统的地图上查看位置。(2)采集设备的远程控制：利用微信小程序可以控制采集设备的报警，方便寻找设备。(3)采集设备的数据查看：移动端小程序可以查看该用户下安装设备的所有数据。(4)窃电检测结果的查看：将窃电检测的结果转存到云服务器，移动端小程序获取云服务器的窃电检测结果进行显示。

## 一.采集端
#### MCU芯片型号
stm32f103c8t6

#### 采集芯片
型号：RN8302

通信协议：SPI协议
#### 原理图及PCB
文件名：RN8302-c8t6 V3.1.eprj

绘制软件：立创eda专业版

#### 采集数据类型
电流、电压、频率

#### NBIoT通信模块
移远BC20

#### 服务器
京东云服务器

#### 工程文件
MQTT_HAL_RN8302

## 二.显示端
electricty-theft：嵌入式显示端用于显示采集端上传的数据，通过连接到EMQX服务器或者阿里云服务器， 采用基于IMX6ULL的硬件平台，采用Qt框架采用c++进行开发。

功能：

1.订阅话题的形式获取数据并解析JSON数据，并以文本的形式和曲线的形式进行显示。

2.连接数据库，并根据设备客户端id查询数据，并进行显示

3.连接wifi，实现无线连接。
    
使用方法：
    Qt Creator打开编译之后将编译后的可执行文件拷贝至硬件平台运行即可。
    
注意事项：

1.软键盘的使用，将electricty-theft中的dict整个文件夹拷贝至可执行文件的同目录，将libSoft-keyboard.so拷贝至qt安装目录下plugins/platforminputcontexts即可，我的对应的是/usr/lib/plugins/platforminputcontexts。

2.连接wifi的脚本alientek_usb_wifi_setup.sh根据自己的实际情况进行修改，我的与可执行目录在同一目录。
    
3.用户名注册与登录是连接到本地数据库login.db，开发板需要移植sqlite3，自行移植。移植完毕后，将electricty-theft下的login.db文件拷贝到程序可执行文件同目录即可。sqlite3命令详细自行搜索。
        
        
   
    
    
